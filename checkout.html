<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - VYLO</title>
    <!-- Keep existing styles -->
</head>
<body>
    <!-- Keep existing header -->

    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Secure Checkout</h1>
                <p class="page-subtitle">Complete your order with secure card payment</p>
                <div class="security-badge">
                    ðŸ”’ Secure Card to Crypto Payment via MoonPay
                </div>
            </div>

            <!-- Checkout Content -->
            <div class="checkout-content">
                <!-- Payment Section -->
                <div class="payment-section">
                    <!-- Discount Code Section (keep existing) -->
                    
                    <!-- Crypto Selection -->
                    <h3 class="section-title">ðŸ’° Select Cryptocurrency</h3>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 1rem;">
                        Pay with your card and receive crypto automatically in our wallet
                    </p>
                    <div class="crypto-selection">
                        <div class="crypto-option" data-crypto="BTC" onclick="selectCrypto('BTC')">
                            <div class="crypto-icon">ðŸ”—</div>
                            <div class="crypto-name">Bitcoin</div>
                            <div class="crypto-symbol">BTC</div>
                        </div>
                        <div class="crypto-option" data-crypto="ETH" onclick="selectCrypto('ETH')">
                            <div class="crypto-icon">ðŸ’Ž</div>
                            <div class="crypto-name">Ethereum</div>
                            <div class="crypto-symbol">ETH</div>
                        </div>
                        <div class="crypto-option" data-crypto="LTC" onclick="selectCrypto('LTC')">
                            <div class="crypto-icon">âš¡</div>
                            <div class="crypto-name">Litecoin</div>
                            <div class="crypto-symbol">LTC</div>
                        </div>
                        <div class="crypto-option" data-crypto="XRP" onclick="selectCrypto('XRP')">
                            <div class="crypto-icon">ðŸŒŠ</div>
                            <div class="crypto-name">Ripple</div>
                            <div class="crypto-symbol">XRP</div>
                        </div>
                    </div>

                    <!-- Payment Button -->
                    <div style="margin-top: 2rem; text-align: center;">
                        <button class="checkout-btn" onclick="proceedToPayment()" id="paymentBtn" disabled>
                            ðŸ’³ Pay with Card via MoonPay
                        </button>
                        <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; margin-top: 1rem;">
                            Powered by MoonPay - Secure card payments converted to cryptocurrency
                        </p>
                    </div>
                </div>

                <!-- Order Summary (keep existing) -->
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:3001/api'; // Update with your backend URL
        let selectedCrypto = null;
        let orderTotal = 0;

        // Get authentication token
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Select cryptocurrency
        function selectCrypto(crypto) {
            selectedCrypto = crypto;
            
            // Update UI
            document.querySelectorAll('.crypto-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-crypto="${crypto}"]`).classList.add('selected');
            
            // Enable payment button
            document.getElementById('paymentBtn').disabled = false;
        }

        // Proceed to MoonPay payment
        async function proceedToPayment() {
            if (!selectedCrypto) {
                alert('Please select a cryptocurrency');
                return;
            }

            const paymentBtn = document.getElementById('paymentBtn');
            paymentBtn.disabled = true;
            paymentBtn.textContent = 'ðŸ’³ Creating Payment...';

            try {
                // Get user email
                const userEmail = localStorage.getItem('userEmail');
                
                // Create MoonPay transaction
                const response = await fetch(`${API_BASE}/moonpay/create-transaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        orderTotal: orderTotal,
                        cryptoCurrency: selectedCrypto,
                        userEmail: userEmail
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment');
                }

                const data = await response.json();
                
                // Store transaction ID for later reference
                localStorage.setItem('pendingOrderId', data.externalTransactionId);
                
                // Redirect to MoonPay
                window.location.href = data.paymentUrl;

            } catch (error) {
                console.error('Payment creation error:', error);
                alert('Failed to create payment. Please try again.');
                paymentBtn.disabled = false;
                paymentBtn.textContent = 'ðŸ’³ Pay with Card via MoonPay';
            }
        }

        // Rest of your existing JavaScript...
        // Update calculateTotals, renderOrderSummary etc. to work with the database
    </script>
</body>
</html>